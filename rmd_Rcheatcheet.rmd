---
title: "R Useful Functions"
author: "Dr Chris McNeil"
date: "13/04/2021"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*** 
# Collection of useful R syntax and methods

## Introduction

This document is intended to collect all the useful code snippets I have collected since I started using R and R studio.

I intend to organise the snippets into sections.

* data wrangling.
* data restructuring
* data manipulation (creating new variables)
* statistical analysis – basic
* statistical analysis - advanced
* data visualisation

ultimately, I want this to be a working document with examples to run. I will load the required libraries when they are needed.

Initially I will use the mtcars example database

## R basic functions:

### Manipulating the environment

Remove  Items from environment:

```{r}
data("mtcars")
data("band_instruments")
data("band_instruments2") # Load example datasets
```

Remove items
```{r}
rm(list=ls()[! ls() %in% c("band_instruments","band_instruments2")]) # Everything except Band instruments
rm(list=setdiff(ls(), "band_instruments")) # Everything except "bandinstruments"
rm(list=ls()) # Remove everything
```
Reference:
[Stackoverflow](https://stackoverflow.com/questions/6190051/how-can-i-remove-all-objects-but-one-from-the-workspace-in-r)

Remove a package (library)

```{r}
#Unload a module: 
library(clipr) #load
detach(package:clipr) #unload
```


***

## Data wrangling

```{r}
library(knitr) # for better looking tables when knitted to html
library(kableExtra) # for even better looking tables when knitted to html
```
Reference for table formatting
[Kable Extra](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)

### Recode a text variable

Tidyverse libraries are needed for the following examples.


```{r message=FALSE}
library(tidyverse)
data("band_members")
kable(head(band_members)) %>% kable_minimal(full_width = F)
band_members <- band_members %>% mutate(name=recode(name, "Mick"= "m"))
kable(head((band_members))) %>% kable_minimal(full_width = F)
rm(list=ls()) # Remove everything
```

### Bin variable based on The value ( e.g. Low/Medium/High)

```{r}
data(mtcars)
mtcars <- mtcars %>% mutate(hp_cat=cut(hp, breaks=c(-Inf, 100, Inf), labels=c("low hp","high hp")))
```

### Perform a function that is conditional 

```{r}
mtcars <- mtcars %>% mutate(loghp=ifelse(cyl>4,log10(hp),NA)) # Nonsensical example, but log transformed all horse powers of cars with more than four cylinders
```

### Conditional Replacements

Replace all 'NA's in a specified variable with 0.
```{r}
mtcars <- mtcars %>% mutate(loghp1 = coalesce(loghp, 0))

#or

mtcars <- mtcars %>% mutate(loghp = replace_na(loghp, "missing"))
```

### Filter individuals with na's in a specified variable, or just retain complete cases

```{r}
mtcars <- mtcars %>% filter(!is.na(hp)) # no missing values found
mtcars <- mtcars %>%filter(complete.cases(.)) # no missing values found
```


### Delete specified columns

```{r}
mtcars1 <- mtcars %>% select(-(drat)) # single column
mtcars2 <- mtcars %>% select(-c(drat,hp,vs:gear)) # multiple columns

rm(list=setdiff(ls(), "mtcars")) # clean environment
```

### Find duplicate rows (e.g. duplicated participant datasets)

```{r}
n_occur1 <- data.frame(table(mtcars$mpg)) # specify which variable to check for duplication
n_occur1[n_occur1$Freq > 1,]
```

### Delete rows (individuals) based on value of a variable

```{r}
mtcars1<-mtcars %>% filter(!(cyl==6))
mtcars2<-mtcars %>% filter(!(cyl==6 | hp==180)) # | is the 'or' operator
mtcars3<-mtcars %>% filter(!(cyl==8 & hp==215)) # & is the 'and' operator

# remove the ! To select the individuals with the specified conditions

```


### Use if else to calculate based on values

```{r}
mtcars <- mtcars %>% mutate(vs=ifelse(is.na(vs),(carb-am)/365.25,vs)) # no NA's so all values unchanged.
```


### Merge data frames by adding individuals not variables


```{r}
mtcarsmerged <- bind_rows(mtcars2, mtcars3)
rm(list=setdiff(ls(), "mtcars")) # clean environment
```

[Reference](https://dplyr.tidyverse.org/reference/bind.html)


## Statistical Methods

### Linear Regression

**Summarise and do Linear regression on multiple groups
```{r}
mtcars %>%  group_by(as.factor(gear)) %>% summarise(mean = mean(qsec), sd = sd(qsec))

#What if you wanted to run the same linear regression model by the different group levels?  Instead of running #summary(lm(y~x)) for the number of levels you have, you can use the R package “broom” along with dplyr.

library(broom)

## run the same regression model for gears ##
mtcars%>% group_by(gear) %>%
  do(fitgear = glance(lm(hp~qsec, data = .))) %>% 
  unnest(fitgear)
```

[Reference](https://stackoverflow.com/questions/22713325/fitting-several-regression-models-with-dplyr)







